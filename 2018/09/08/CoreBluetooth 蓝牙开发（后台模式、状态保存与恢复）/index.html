<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Jarvis.卢的个人博客"><meta name="keywords" content="blog, 技术博客, IT"><title>CoreBluetooth 蓝牙开发（后台模式、状态保存与恢复） | 望月@Jarvis</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CoreBluetooth 蓝牙开发（后台模式、状态保存与恢复）</h1><a id="logo" href="/.">望月@Jarvis</a><p class="description">在时光的流逝中我把将近而立之年之前的时间都荒废了，接下来我要把荒废时间的赚回来！</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">CoreBluetooth 蓝牙开发（后台模式、状态保存与恢复）</h1><div class="post-meta"><a href="/2018/09/08/CoreBluetooth 蓝牙开发（后台模式、状态保存与恢复）/#comments" class="comment-count"></a><p><span class="date">Sep 08, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>最近新进一家公司，主要是做物联网这一块的的，项目需要用到蓝牙开发，讲真的，挑战还是挺大的，做了差不多四年的iOS开发，从没有接触过蓝牙开发这一领域，我是这样学习的。</p>
<p>从网上找各种博客（国内的，国外的），借鉴别人写过的Demo以及官方文档，花了整整的一周时间，对iOS的CoreBluetooth这个框架的使用稍微有一些的了解，请听我一一道来；</p>
<h1 id="iOS-蓝牙"><a href="#iOS-蓝牙" class="headerlink" title="iOS 蓝牙"></a>iOS 蓝牙</h1><blockquote>
<p>简称：BLE（buletouch low energy），蓝牙 4.0 设备因为低耗电，所以也叫做 BLE，CoreBluetooth框架就是苹果公司为我们提供的一个库，我们可以使用这个库和其他支持蓝牙4.0的设备进行数据交互。值得注意的是在IOS10之后的APP中，我们需要在 info.plist文件中添加NSBluetoothPeripheralUsageDescription字段否则APP会崩溃</p>
</blockquote>
<blockquote>
<p>工作模式：蓝牙通信中，首先需要提到的就是 central 和 peripheral 两个概念。这是设备在通信过程中扮演的两种角色。直译过来就是 [中心] 和 [周边（可以理解为外设）]。iOS 设备既可以作为 central，也可以作为 peripheral，这主要取决于通信需求。</p>
</blockquote>
<p>自己尝试的写了个<a href="https://github.com/DeanMr/MSBBlueTooth" target="_blank" rel="noopener">Demo</a>,实现的功能有：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、通过已知外围设备的服务UUID搜索（这个UUID是指被广播出来的服务UUID）；</span><br><span class="line"><span class="number">2</span>、连接指定的外围设备；</span><br><span class="line"><span class="number">3</span>、获取指定的服务，发现需要订阅的特征；</span><br><span class="line"><span class="number">4</span>、接收外围设备发送的数据；</span><br><span class="line"><span class="number">5</span>、向外围设备写数据；</span><br><span class="line"><span class="number">6</span>、实现蓝牙服务的后台模式；</span><br><span class="line"><span class="number">7</span>、实现蓝牙服务的状态保存与恢复（应用被系统杀死的时候，系统会自动保存 central manager 的状态）；</span><br></pre></td></tr></table></figure>

<h1 id="中心角色的实现：（central）"><a href="#中心角色的实现：（central）" class="headerlink" title="中心角色的实现：（central）"></a>中心角色的实现：（central）</h1><p>  ##（1）、初始化中央管理器对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">第一个参数：代理</span></span><br><span class="line"><span class="comment">第二个参数：队列（nil为不指定队列，默认为主队列）</span></span><br><span class="line"><span class="comment">第三个参数：实现状态保存的时候需要用到 eg:@&#123;CBCentralManagerOptionRestoreIdentifierKey:@"centralManagerIdentifier"&#125; </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line">centerManager = [[CBCentralManager alloc]initWithDelegate:self <span class="built_in">queue</span>:<span class="built_in">queue</span> options:options];</span><br></pre></td></tr></table></figure>

<p> 中央管理器会调用 centralManagerDidUpdateState:通知蓝牙的状态</p>
<h2 id="2-、发现外围设备"><a href="#2-、发现外围设备" class="headerlink" title="(2)、发现外围设备"></a>(2)、发现外围设备</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[centralManager scanForPeripheralsWithServices:@<span class="string">[[CBUUID UUIDWithString:SERVICE_UUID]]</span> options：<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<p> 每次中央管理器发现外围设备时，它都会调用centralManager:didDiscoverPeripheral:advertisementData:RSSI:其委托对象的方法。</p>
<h2 id="3-、发现想要的外围设备进行连接"><a href="#3-、发现想要的外围设备进行连接" class="headerlink" title="(3)、发现想要的外围设备进行连接"></a>(3)、发现想要的外围设备进行连接</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark -- 扫描发现到任何一台设备都会通过这个代理方法回调</span></span><br><span class="line">- (<span class="keyword">void</span>)centralManager:(CBCentralManager *)central didDiscoverPeripheral:(CBPeripheral *)peripheral advertisementData:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)advertisementData RSSI:(<span class="built_in">NSNumber</span> *)RSSI</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//过滤掉无效的结果</span></span><br><span class="line">    <span class="keyword">if</span> (peripheral == <span class="literal">nil</span>||peripheral.identifier == <span class="literal">nil</span><span class="comment">/*||peripheral.name == nil*/</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *pername =[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,peripheral.name];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"所有服务****：%@"</span>,peripheral.services);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"蓝牙名字：%@  信号强弱：%@"</span>,pername,RSSI);</span><br><span class="line">   <span class="comment">//连接需要的外围设备</span></span><br><span class="line">    [<span class="keyword">self</span> connectPeripheral:peripheral];</span><br><span class="line">    <span class="comment">//将搜索到的设备添加到列表中</span></span><br><span class="line">    [<span class="keyword">self</span>.peripherals addObject:peripheral];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_didDiscoverPeripheralBlock) &#123;</span><br><span class="line">        _didDiscoverPeripheralBlock(central,peripheral,advertisementData,RSSI);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 如果连接请求成功，则中央管理器调用centralManager:didConnectPeripheral:其委托对象的方法。</p>
<p>##（4）、发现所连接的外围设备的服务</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> <span class="selector-tag">--</span> 连接成功、获取当前设备的服务和特征 并停止扫描</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">centralManager</span><span class="selector-pseudo">:(CBCentralManager</span> *)<span class="selector-tag">central</span> <span class="selector-tag">didConnectPeripheral</span><span class="selector-pseudo">:(CBPeripheral</span> *)<span class="selector-tag">peripheral</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%@"</span>,peripheral);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置设备代理</span></span><br><span class="line">    <span class="selector-attr">[peripheral setDelegate:self]</span>;</span><br><span class="line">    <span class="comment">// 大概获取服务和特征</span></span><br><span class="line">    <span class="selector-attr">[peripheral discoverServices:@[[CBUUID UUIDWithString:SERVICE_UUID]</span>]];</span><br><span class="line">    </span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"Peripheral Connected"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="selector-tag">if</span> (_centerManager.isScanning) &#123;</span><br><span class="line">        <span class="selector-attr">[_centerManager stopScan]</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"Scanning stopped"</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现指定的服务时，外围设备（CBPeripheral你连接的对象）会调用peripheral:didDiscoverServices:其委托对象的方法。</p>
<h2 id="5-、发现服务的特征"><a href="#5-、发现服务的特征" class="headerlink" title="(5)、发现服务的特征"></a>(5)、发现服务的特征</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> <span class="selector-tag">--</span> 获取当前设备服务<span class="selector-tag">services</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">peripheral</span><span class="selector-pseudo">:(CBPeripheral</span> *)<span class="selector-tag">peripheral</span> <span class="selector-tag">didDiscoverServices</span><span class="selector-pseudo">:(NSError</span> *)<span class="selector-tag">error</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-tag">if</span> (error) &#123;</span><br><span class="line">        <span class="selector-tag">NSLog</span>(@<span class="string">"Error discovering services: %@"</span>, [error localizedDescription]);</span><br><span class="line">        <span class="selector-tag">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"所有的servicesUUID%@"</span>,peripheral.services);   </span><br><span class="line">    <span class="comment">//遍历所有service</span></span><br><span class="line">    <span class="selector-tag">for</span> (CBService *service in peripheral.services)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="selector-tag">NSLog</span>(@<span class="string">"服务%@"</span>,service.UUID);</span><br><span class="line">        <span class="comment">//找到你需要的servicesuuid</span></span><br><span class="line">        <span class="selector-tag">if</span> ([[NSString <span class="attribute">stringWithFormat</span>:@<span class="string">"%@"</span>,service.UUID] <span class="attribute">isEqualToString</span>:SERVICE_UUID])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 根据UUID寻找服务中的特征</span></span><br><span class="line">            <span class="selector-attr">[peripheral discoverCharacteristics:@[[CBUUID UUIDWithString:CHARACTERISTIC_UUID]</span>] <span class="selector-tag">forService</span><span class="selector-pseudo">:service</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>peripheral:didDiscoverCharacteristicsForService:error:当发现指定服务的特征时，外围设备调用其委托对象的方法。</p>
<h2 id="6-、检索特征价值"><a href="#6-、检索特征价值" class="headerlink" title="(6)、检索特征价值"></a>(6)、检索特征价值</h2><p>阅读特征的值 ()</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[peripheral readValueForCharacteristic：interestingCharacteristic]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 注意：  并非所有特征都是可读的。你可以通过检查其properties属性是否包含CBCharacteristicPropertyRead常量来确定特征是否可读。如果尝试读取不可读的特征值，则peripheral:didUpdateValueForCharacteristic:error:委托方法将返回合适的错误。</p>
</blockquote>
<h4 id="订阅特征的值（）"><a href="#订阅特征的值（）" class="headerlink" title="订阅特征的值（）"></a>订阅特征的值（）</h4><p>虽然使用该readValueForCharacteristic:方法读取特征值对静态值有效，但它不是检索动态值的最有效方法。检索随时间变化的特征值 - 例如，你的心率 - 通过订阅它们。订阅特征值时，您会在值更改时收到外围设备的通知。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[peripheral setNotifyValue：YES forCharacteristic：interestingCharacteristic]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：  并非所有特征都提供订阅。你可以通过检查特性是否properties包含其中一个CBCharacteristicPropertyNotify或多个CBCharacteristicPropertyIndicate常量来确定特征是否提供订阅。<br> 当你订阅（或取消订阅）特征的值时，外围设备会调用peripheral:didUpdateNotificationStateForCharacteristic:error:其委托对象的方法。</p>
</blockquote>
<h4 id="写一个特征的值"><a href="#写一个特征的值" class="headerlink" title="写一个特征的值 ()"></a>写一个特征的值 ()</h4><p>有时写一个特征的值是有意义的。例如，如果你的应用程序与蓝牙低功耗数字恒温器交互，你可能需要为恒温器提供设置房间温度的值。如果特征值是可写的，则可以NSData通过调用外设writeValue:forCharacteristic:type:方法将数据值;</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[</span><span class="built_in">self</span>.discoveredPeripheral writeValue:<span class="built_in">data</span> forCharacteristic:<span class="built_in">self</span>.characteristic1 <span class="keyword">type</span>:CBCharacteristicWriteWithResponse<span class="meta">]</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>写入特征的值时，指定要执行的写入类型。在上面的示例中，写入类型CBCharacteristicWriteWithResponse指示外围设备通过调用peripheral:didWriteValueForCharacteristic:error:其委托对象的方法让您的应用程序知道写入是否成功。</p>
</blockquote>
<h1 id="外围角色的实现"><a href="#外围角色的实现" class="headerlink" title="外围角色的实现"></a>外围角色的实现</h1><h2 id="（1）、初始化外围设备管理器"><a href="#（1）、初始化外围设备管理器" class="headerlink" title="（1）、初始化外围设备管理器"></a>（1）、初始化外围设备管理器</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peripheralManager = [[CBPeripheralManager alloc] initWithDelegate：<span class="keyword">self</span> queue：<span class="literal">nil</span> options：<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<p>创建外围设备管理器时，外围设备管理器会调用peripheralManagerDidUpdateState:其委托对象的方法。您必须实现此委托方法，以确保支持蓝牙低功耗并可在本地外围设备上使用。</p>
<h2 id="（2）、设置服务和特征"><a href="#（2）、设置服务和特征" class="headerlink" title="（2）、设置服务和特征"></a>（2）、设置服务和特征</h2><blockquote>
<p>为自定义服务和特征创建自己的UUID<br> 在终端使用 uuidgen 命令获取以ASCII字符串形式的128位值的UUID：71DA3FD1-7E10-41C1-B16F-4430B506CDE7</p>
</blockquote>
<blockquote>
<p> 构建服务树和特征</p>
</blockquote>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myCharacteristic =<span class="comment">[<span class="comment">[CBMutableCharacteristic alloc]</span> initWithType：myCharacteristicUUID properties：CBCharacteristicPropertyRead value：myValue permissions：CBAttributePermissionsReadable]</span>;   //特征</span><br><span class="line"> myService = <span class="comment">[<span class="comment">[CBMutableService alloc]</span> initWithType：myServiceUUID primary：YES]</span>;    //与特征所关联的服务</span><br><span class="line"></span><br><span class="line">myService.characteristics = @ <span class="comment">[myCharacteristic]</span>;        //设置服务的特征数组,将特征与其关联</span><br></pre></td></tr></table></figure>

<h2 id="（3）、发布服务和特征"><a href="#（3）、发布服务和特征" class="headerlink" title="（3）、发布服务和特征"></a>（3）、发布服务和特征</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[peripheralManager addService：myService]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当调用此方法发布服务时，外围管理器将调用peripheralManager:didAddService:error:其委托对象的方法。通过error可以知道是否发布成功;<br> 将服务及其任何关联特性发布到外围设备的数据库后，该服务将被缓存，将无法再对其进行更改。</p>
</blockquote>
<h2 id="（4）、广播服务"><a href="#（4）、广播服务" class="headerlink" title="（4）、广播服务"></a>（4）、广播服务</h2><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">peripheralManager</span> startAdvertising：@ &#123;CBAdvertisementDataServiceUUIDsKey：@[<span class="name">myFirstService.UUID，mySecondService.UUID</span>]&#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>当开始在本地外围设备上公布某些数据时，外围设备管理器会调用peripheralManagerDidStartAdvertising:error:其委托对象的方法。</p>
<h2 id="（5）、响应来自中央的读取和写入请求"><a href="#（5）、响应来自中央的读取和写入请求" class="headerlink" title="（5）、响应来自中央的读取和写入请求"></a>（5）、响应来自中央的读取和写入请求</h2><p> 当连接的中央请求读取某个特征的值时，外围管理器会调用peripheralManager:didReceiveReadRequest:其委托对象的方法。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[peripheralManager respondToRequest：request withResult：CBATTErrorInvalidOffset]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>  设置读取请求不要求从超出特征值的边界的索引位置读取</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">request.value</span> = [myCharacteristic.value subdataWithRange：NSMakeRange（request.<span class="literal">off</span>set，myCharacteristic.value.length  -  request.<span class="literal">off</span>set）]<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p> 将请求的特性属性（默认值为nil）的值设置为您在本地外围设备上创建的特征值，同时考虑读取请求的偏移量</p>
<blockquote>
<p>设置值后，响应远程中央以指示请求已成功完成。通过调用类的respondToRequest:withResult:方法CBPeripheralManager，传回请求（其更新的值）和请求的结果</p>
</blockquote>
<blockquote>
<p>当连接的中心发送写入一个或多个特征值的请求时，外围管理器会调用peripheralManager:didReceiveWriteRequests:其委托对象的方法</p>
</blockquote>
<h2 id="（6）、将更新的特征值发送到订阅的中心"><a href="#（6）、将更新的特征值发送到订阅的中心" class="headerlink" title="（6）、将更新的特征值发送到订阅的中心"></a>（6）、将更新的特征值发送到订阅的中心</h2><blockquote>
<p>当连接的中心订阅某个特征的值时，外围管理器会调用peripheralManager:central:didSubscribeToCharacteristic:其委托对象的方法<br>获取特征的更新值，并通过调用类的updateValue:forCharacteristic:onSubscribedCentrals:方法将其发送到中心CBPeripheralManager。</p>
</blockquote>
<h1 id="处理常驻后台任务"><a href="#处理常驻后台任务" class="headerlink" title="处理常驻后台任务"></a>处理常驻后台任务</h1><blockquote>
<p>首先需要在Capabilities–&gt;Background Modes申请中心角色的后台模式说明</p>
</blockquote>
<p>如图：<br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g4muts4sh7j30n707bwf1.jpg" alt="中心角色后台模式.jpg"></p>
<h2 id="（1）、状态保存与恢复"><a href="#（1）、状态保存与恢复" class="headerlink" title="（1）、状态保存与恢复"></a>（1）、状态保存与恢复</h2><p> 因为状态的保存和恢复 Core Bluetooth 都为我们封装好了，所以我们只需要选择是否需要这个特性即可。系统会保存当前 central manager 或 peripheral manager，并且继续执行蓝牙相关事件（即使程序已经不再运行）。一旦事件执行完毕，系统会在后台重启 app，这时你有机会去存储当前状态，并且处理一些事物。在之前提到的 “门锁” 的例子中，系统会监视连接请求，并在 centralManager:didConnectPeripheral: 回调时，重启 app，在用户回家后，连接操作结束。</p>
<blockquote>
<p>Core Bluetooth 的状态保存与恢复在设备作为 central、peripheral 或者这两种角色时，都可用。在设备作为 central 并添加了状态保存与恢复支持后，如果 app 被强行关闭进程，系统会自动保存 central manager 的状态（如果 app 有多个 central manager，你可以选择哪一个需要系统保存）。</p>
</blockquote>
<p>对于 CBCentralManager，系统会保存以下信息：</p>
<blockquote>
<p>central 准备连接或已经连接的 peripheral<br>central 需要扫描的 service（包括扫描时，配置的 options）<br>central 订阅的 characteristic<br>对于 peripheral 来说，情况也差不多。系统对 CBPeripheralManager 的处理方式如下：<br>peripheral 在广播的数据<br>peripheral 存入的 service 和 characteristic 的树形结构<br>已经被 central 订阅了的 characteristic 的值<br>当系统在后台重新加载程序后（可能是因为找到了要找的 peripheral），你可以重新实例化 central manager 或 peripheral 并恢复他们的状态。</p>
</blockquote>
<h2 id="（2）、选择支持存储和恢复"><a href="#（2）、选择支持存储和恢复" class="headerlink" title="（2）、选择支持存储和恢复"></a>（2）、选择支持存储和恢复</h2><blockquote>
<p>如果要支持存储和恢复，则需要在初始化 manager 的时候给一个 restoration identifier。restoration identifier 是 string 类型，并标识了 app 中的 central manager 或 peripheral manager。这个 string 很重要，它将会告诉 Core Bluetooth 需要存储状态，毕竟 Core Bluetooth 恢复有 identifier 的对象。</p>
</blockquote>
<p>例如，在 central 端，要想支持该特性，可以在调用 CBCentralManager 的初始化方法时，配置 CBCentralManagerOptionRestoreIdentifierKey：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">centralManager = [[CBCentralManager alloc] <span class="string">initWithDelegate:</span>self </span><br><span class="line"><span class="string">queue:</span>nil</span><br><span class="line"><span class="string">options:</span>@&#123;<span class="string">CBCentralManagerOptionRestoreIdentifierKey:</span>@<span class="string">"centralManagerIdentifier"</span>&#125;];</span><br></pre></td></tr></table></figure>

<p>虽然以上代码没有展示出来，其实在 peripheral manager 中要设置 identifier 也是这样的。只是在初始化时，将 key 改成了 CBPeripheralManagerOptionRestoreIdentifierKey。<br>因为程序可以有多个 CBCentralManager 和 CBPeripheralManager，所以要确保每个 identifier 都是唯一的。</p>
<h2 id="（3）、重新初始化-central-manager-和-peripheral-manager"><a href="#（3）、重新初始化-central-manager-和-peripheral-manager" class="headerlink" title="（3）、重新初始化 central manager 和 peripheral manager"></a>（3）、重新初始化 central manager 和 peripheral manager</h2><blockquote>
<p>当系统重新在后台加载程序时，首先需要做的即根据存储的 identifier，重新初始化 central manager 或 peripheral manager。如果你只有一个 manager，并且 manager 存在于 app 生命周期中，那这个步骤就不需要做什么了。<br>.<br>如果 app 中包含多个 manager，或者 manager 不是在整个 app 生命周期中都存在的，那 app 就必须要区分你要重新初始化哪个 manager 了。你可以通过从 app delegate 中的 application:didFinishLaunchingWithOptions: 中取出 key（UIApplicationLaunchOptionsBluetoothCentralsKey 或 UIApplicationLaunchOptionsBluetoothPeripheralsKey）中的 value（数组类型）来得到程序退出之前存储的 manager identifier 列表：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application</span><br><span class="line">didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *centralManagerIdentifiers =</span><br><span class="line">    launchOptions[<span class="built_in">UIApplicationLaunchOptionsBluetoothCentralsKey</span>];</span><br><span class="line">    <span class="keyword">if</span> (centralManagerIdentifiers.count) &#123;</span><br><span class="line">        <span class="comment">//重新初始化所有的 manager </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *identifier <span class="keyword">in</span> centralManagerIdentifiers) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"系统启动项目"</span>);</span><br><span class="line">            <span class="comment">//在这里创建的蓝牙实例一定要被当前类持有，不然出了这个函数就被销毁了，蓝牙检测会出现“XPC connection invalid”</span></span><br><span class="line">            <span class="keyword">self</span>.bluetooth = [[MSBBlueTooth alloc]initWithQueue:<span class="literal">nil</span> options:@&#123;CBCentralManagerOptionRestoreIdentifierKey : identifier&#125;];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="（4）、实现恢复状态的代理方法"><a href="#（4）、实现恢复状态的代理方法" class="headerlink" title="（4）、实现恢复状态的代理方法"></a>（4）、实现恢复状态的代理方法</h2><blockquote>
<p>在重新初始化 manager 之后，接下来需要同步 Core Bluetooth 存储的他们的状态。要想弄清楚在程序被退出时都在做些什么，就需要正确的实现代理方法。对于 central manager 来说，需要实现 centralManager:willRestoreState:；对于 peripheral manager 来说，需要实现 peripheralManager:willRestoreState:。<br>.<br>注意：如果选择存储和恢复状态，当系统在后台重新加载程序时，首先调用的方法是 centralManager:willRestoreState: 或 peripheralManager:willRestoreState:。如果没有选择存储的恢复状态（或者唤醒时没有什么内容需要恢复），那么首先调用的方法是 centralManagerDidUpdateState: 或 peripheralManagerDidUpdateState:。<br>.<br>无论是以上哪种代理方法，最后一个参数都是一个包含程序退出前状态的字典。字典中，可用的 key ，</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">central 端有：</span><br><span class="line"><span class="built_in">NSString</span> *<span class="keyword">const</span> CBCentralManagerRestoredStatePeripheralsKey;</span><br><span class="line"><span class="built_in">NSString</span> *<span class="keyword">const</span> CBCentralManagerRestoredStateScanServicesKey;</span><br><span class="line"><span class="built_in">NSString</span> *<span class="keyword">const</span> CBCentralManagerRestoredStateScanOptionsKey;</span><br><span class="line"></span><br><span class="line">peripheral 端有：</span><br><span class="line"><span class="built_in">NSString</span> *<span class="keyword">const</span> CBPeripheralManagerRestoredStateServicesKey;</span><br><span class="line"><span class="built_in">NSString</span> *<span class="keyword">const</span> CBPeripheralManagerRestoredStateAdvertisementDataKey;</span><br></pre></td></tr></table></figure>

<p>要恢复 central manager 的状态，可以用 centralManager:willRestoreState: 返回字典中的 key 来得到。假如说 central manager 有想要或者已经连接的 peripheral，那么可以通过 CBCentralManagerRestoredStatePeripheralsKey 对应得到的 peripheral（CBPeripheral 对象）数组来得到。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)centralManager:(CBCentralManager *)central</span><br><span class="line">willRestoreState:(<span class="built_in">NSDictionary</span> *)state &#123;</span><br><span class="line"><span class="built_in">NSArray</span> *peripherals = dict[CBCentralManagerRestoredStatePeripheralsKey];</span><br><span class="line">    <span class="comment">//讲状态保存的设备加入列表，在蓝牙检测状态的回调里实现重连</span></span><br><span class="line">    <span class="keyword">self</span>.peripherals = [<span class="built_in">NSMutableArray</span> arrayWithArray:peripherals];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>具体要对拿到的 peripheral 数组做什么就要根据需求来了。如果这是个 central manager 搜索到的 peripheral 数组，那就可以存储这个数组的引用，并且开始建立连接了（注意给这些 peripheral 设置代理，否则连接后不会走 peripheral 的代理方法）。<br>.<br>恢复 peripheral manager 的状态和 central manager 的方式类似，就只是把代理方法换成了 peripheralManager:willRestoreState:，并且使用对应的 key 即可</p>
</blockquote>
<p>写的不是很好，也算是东拼西凑了，但也是花了时间去整理的，如果看不懂，可以下载我的Demo自己跑一遍；</p>
<p>想要看实现效果，可以下载<a href="https://github.com/DeanMr/MSBBlueTooth" target="_blank" rel="noopener">Demo</a>,看的再多也不如项目跑一遍来的快，疗效是不骗人的；</p>
<p>有需要的可以加我微信BHS3579，一起讨论学习</p>
<p>喜欢就点个赞，也可以在下方评论一起讨论讨论</p>
</div><div class="post-copyright"><blockquote><p>原文作者: Jarvis</p><p>原文链接: <a href="http://yoursite.com/2018/09/08/CoreBluetooth 蓝牙开发（后台模式、状态保存与恢复）/">http://yoursite.com/2018/09/08/CoreBluetooth 蓝牙开发（后台模式、状态保存与恢复）/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/01/11/iOS 地图轨迹回放之播放、暂停、加速、减速（高德地图）/" class="pre">iOS 地图轨迹回放之播放、暂停、加速、减速（高德地图）</a><a href="/2018/06/01/iOS webApp 审核被拒(包括ipv6)/" class="next">iOS webApp 审核被拒(包括ipv6)</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80NTA3OC8yMTU5NQ=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#iOS-蓝牙"><span class="toc-text">iOS 蓝牙</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#中心角色的实现：（central）"><span class="toc-text">中心角色的实现：（central）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-、发现外围设备"><span class="toc-text">(2)、发现外围设备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-、发现想要的外围设备进行连接"><span class="toc-text">(3)、发现想要的外围设备进行连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-、发现服务的特征"><span class="toc-text">(5)、发现服务的特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-、检索特征价值"><span class="toc-text">(6)、检索特征价值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#订阅特征的值（）"><span class="toc-text">订阅特征的值（）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#写一个特征的值"><span class="toc-text">写一个特征的值 ()</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#外围角色的实现"><span class="toc-text">外围角色的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#（1）、初始化外围设备管理器"><span class="toc-text">（1）、初始化外围设备管理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（2）、设置服务和特征"><span class="toc-text">（2）、设置服务和特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（3）、发布服务和特征"><span class="toc-text">（3）、发布服务和特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（4）、广播服务"><span class="toc-text">（4）、广播服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（5）、响应来自中央的读取和写入请求"><span class="toc-text">（5）、响应来自中央的读取和写入请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（6）、将更新的特征值发送到订阅的中心"><span class="toc-text">（6）、将更新的特征值发送到订阅的中心</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#处理常驻后台任务"><span class="toc-text">处理常驻后台任务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#（1）、状态保存与恢复"><span class="toc-text">（1）、状态保存与恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（2）、选择支持存储和恢复"><span class="toc-text">（2）、选择支持存储和恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（3）、重新初始化-central-manager-和-peripheral-manager"><span class="toc-text">（3）、重新初始化 central manager 和 peripheral manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#（4）、实现恢复状态的代理方法"><span class="toc-text">（4）、实现恢复状态的代理方法</span></a></li></ol></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/08/Flutter之TabBar的实现/">Flutter之tabBar的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/07/Flutter学习之布局/">Flutter学习之布局</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/07/Https请求过程/">Https请求过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/06/Swift VS Objective-C（一）/">Swift VS Objective-C</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/内联样式之三目运算符/">内联样式之三目运算符</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/Mac下个人博客的搭建之旅/">Mac下个人博客的搭建之旅</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/c版本的哈希与javaScript版本的哈希/">c版本的哈希与javaScript版本的哈希</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/小程序学习之--Flex布局/">小程序学习之--Flex布局</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/iOS 地图轨迹回放之播放、暂停、加速、减速（高德地图）/">iOS 地图轨迹回放之播放、暂停、加速、减速（高德地图）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/100000/" style="font-size: 15px;">100000</a> <a href="/tags/100001/" style="font-size: 15px;">100001</a> <a href="/tags/10002/" style="font-size: 15px;">10002</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://www.jianshu.com/u/7c653d55efb4" title="简书" target="_blank">简书</a><ul></ul><a href="http://www.cnblogs.com/qwer-BHS/" title="博客园" target="_blank">博客园</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Jarvis.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>